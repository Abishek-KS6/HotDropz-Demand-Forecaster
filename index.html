<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotDropz - Seasonal Demand Forecasting</title>
    
    <!-- Chosen Palette: Dark Navy (#111827, #1f2937), Gold/Amber (#f59e0b), and Cool Gray accents. -->
    <!-- Application Structure Plan: A single-page dashboard designed for clarity and actionability. The architecture uses a fixed header for branding and primary user actions (Profile, Data Analysis), a main control panel for data filtering (Season, Category, Region, Search), and a dynamic grid for displaying product forecast cards. Interactive modals are used for deep-dives (Product Details with charts), user management (Authentication), and advanced tools (AI Description Generator, Chatbot), ensuring the main view remains uncluttered. This structure was chosen to guide the user from a broad overview to specific, actionable insights efficiently. -->
    <!-- Visualization & Content Choices: 
        - Report Info: "Dual-axis line charts showing...Sales Volume and Retail Price Fall." -> Goal: Show Relationship/Change. -> Viz: Chart.js dual-axis line chart on a canvas for detailed product analysis. Interaction: Opens in a modal. Justification: Best tool to show correlation between two different metrics over time.
        - Report Info: "Personalized Data Layer...user's Watchlist." -> Goal: Organize/Personalize. -> Presentation: "Add to Watchlist" button and a dedicated "My Watchlist" filter. Interaction: Simulates saving to Firestore. Justification: Provides a key personalization feature for returning users.
        - Report Info: "Contextual AI Chatbot" & "AI Marketing Tool." -> Goal: Assist/Generate. -> Presentation: Floating chat widget and a button in the product detail modal. Interaction: Simulates Gemini API calls with loading states. Justification: Demonstrates advanced AI integration and provides high-value utility.
        - All other data (Demand Score, Price) is presented textually on cards for quick scanning.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0f172a; /* A deep slate for the background */
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #f59e0b;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #d97706;
        }
        /* Glassmorphism effect for modals */
        .modal-glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        /* Animation for toast notifications */
        .toast {
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }
        @keyframes slideIn {
            from { bottom: -100px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; display: none; }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200">

    <!-- HEADER -->
    <header class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-40 w-full border-b border-slate-700">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
            <!-- Left-aligned Action -->
            <button id="analyze-data-btn" onclick="window.openModal('data-analysis-modal')" class="hidden md:flex items-center space-x-2 text-gray-300 hover:text-amber-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                <span>Analyze My Data</span>
            </button>
            
            <!-- Centered Branding -->
            <div class="flex-1 flex justify-center items-center">
                 <div class="flex items-center space-x-3">
                    <img src="https://placehold.co/40x40/f59e0b/111827?text=H" alt="HotDropz Logo" class="h-10 w-10 rounded-full border-2 border-amber-600">
                    <h1 class="text-2xl md:text-3xl font-bold text-amber-500 tracking-wider">HotDropz</h1>
                </div>
            </div>

            <!-- Right-aligned Action -->
            <button id="auth-btn" onclick="window.openAuthModal()" class="flex items-center space-x-2 text-gray-300 hover:text-amber-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="hidden md:inline">Profile</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- CONTROL PANEL -->
        <div class="bg-slate-800 p-4 rounded-lg shadow-lg mb-8 space-y-6">
            <!-- Filters: Season & Category -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div id="season-filters" class="flex flex-wrap gap-2">
                         <button onclick="window.setSeason('Summer')" class="filter-btn season-btn bg-slate-700 hover:bg-amber-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition-all duration-200">‚òÄÔ∏è Summer</button>
                         <button onclick="window.setSeason('Monsoon')" class="filter-btn season-btn bg-slate-700 hover:bg-amber-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition-all duration-200">üåßÔ∏è Monsoon</button>
                         <button onclick="window.setSeason('Festival')" class="filter-btn season-btn bg-slate-700 hover:bg-amber-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition-all duration-200">ü™î Festival</button>
                         <button onclick="window.setSeason('Winter')" class="filter-btn season-btn bg-slate-700 hover:bg-amber-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition-all duration-200">‚ùÑÔ∏è Winter</button>
                    </div>
                </div>
                <div>
                    <div id="category-filters" class="flex flex-wrap gap-2">
                        {/* Category buttons will be dynamically inserted here */}
                    </div>
                </div>
            </div>
            <!-- Filters: Region & Search -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div>
                    <select id="region-selector" onchange="window.setRegion(this.value)" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2 focus:ring-amber-500 focus:border-amber-500">
                        <option value="National">üáÆüá≥ National Average</option>
                        <option value="North">‚õ∞Ô∏è North India</option>
                        <option value="South">üå¥ South India</option>
                        <option value="Coastal">üåä Coastal Market</option>
                    </select>
                </div>
                <div class="relative">
                    <input type="text" id="search-bar" placeholder="Search products..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2 pl-10 focus:ring-amber-500 focus:border-amber-500">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
             </div>
        </div>

        <!-- PRODUCT LIST -->
        <div id="product-section">
            <h2 id="list-title" class="text-2xl font-bold mb-4 text-amber-500">Select a season to begin...</h2>
            <div id="product-list-container">
                <div id="loading-indicator" class="hidden text-center p-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500"></div>
                    <p class="mt-2 text-lg">Calculating Forecasts...</p>
                </div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {/* Product cards will be dynamically inserted here */}
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="modal-glass rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
            <button onclick="window.closeModal('product-detail-modal')" class="absolute top-4 right-4 text-gray-300 hover:text-white">&times;</button>
            <div id="product-detail-content"></div>
        </div>
    </div>
    
    <!-- Authentication Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="modal-glass rounded-lg shadow-xl w-full max-w-md p-6 relative">
             <button onclick="window.closeModal('auth-modal')" class="absolute top-4 right-4 text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
             <div id="auth-content"></div>
        </div>
    </div>

    <!-- Data Analysis Modal -->
    <div id="data-analysis-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="modal-glass rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
             <button onclick="window.closeModal('data-analysis-modal')" class="absolute top-4 right-4 text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
             <div id="data-analysis-content"></div>
        </div>
    </div>

    <!-- AI Chatbot -->
    <div id="chatbot-container" class="fixed bottom-5 right-5 z-50">
        <div id="chat-widget" class="hidden w-80 h-96 bg-slate-800/80 backdrop-blur-md rounded-lg shadow-2xl flex flex-col transition-all duration-300 mb-20">
            <div class="bg-amber-600 text-white p-3 rounded-t-lg font-bold">Forecast Assistant</div>
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto"></div>
            <div class="p-2 border-t border-slate-700">
                <form id="chat-form" class="flex items-center space-x-2">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-700 text-white rounded-lg p-2 border border-slate-600 focus:ring-amber-500 focus:border-amber-500" placeholder="Ask about trends...">
                    <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </div>
        </div>
        <button id="chatbot-toggle" onclick="window.toggleChat()" class="bg-amber-600 hover:bg-amber-700 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
                <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
            </svg>
        </button>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed right-5 top-5 z-[100] space-y-2"></div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // This is the main application script.
        // It's wrapped in DOMContentLoaded to ensure the HTML is fully loaded before the script runs.
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION & STATE MANAGEMENT ---
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY", // Replace with your actual Firebase config
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            // This is a placeholder check. In a real app, you would have a secure way to provide this.
            // For this project, we'll simulate a working Firebase instance if config is missing.
            const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

            let app, auth, db;
            if (isFirebaseConfigured) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }

            let currentUser = null;
            let userWatchlist = new Set();
            
            let currentSeason = '';
            let currentCategory = 'All';
            let currentRegion = 'National';
            let currentSearchTerm = '';
            
            let debounceTimer;

            const baseProducts = [
                // Summer Products
                { id: "S01", name: "Air Conditioners", season: "Summer", category: "Electronics", demand: 85, price: 35000, sales: [10, 15, 60, 85, 90, 70, 40, 20, 15, 10, 5, 8], materials: ["Copper Coil", "Inverter Tech", "Smart WiFi"] },
                { id: "S02", name: "Cotton T-Shirts", season: "Summer", category: "Fashion", demand: 90, price: 500, sales: [20, 30, 70, 90, 88, 75, 50, 30, 25, 22, 20, 18], materials: ["Pure Cotton", "Linen Blend", "Quick Dry"] },
                { id: "S03", name: "Refrigerators", season: "Summer", category: "Electronics", demand: 78, price: 25000, sales: [30, 40, 65, 78, 80, 72, 60, 50, 45, 40, 35, 32], materials: ["Double Door", "Smart Inverter", "Frost Free"] },
                { id: "S04", name: "Sunscreen Lotion", season: "Summer", category: "Beauty", demand: 95, price: 350, sales: [15, 25, 70, 95, 92, 60, 30, 20, 18, 15, 12, 10], materials: ["SPF 50", "Gel Based", "Water Resistant"] },
                
                // Monsoon Products
                { id: "M01", name: "Umbrellas", season: "Monsoon", category: "Fashion", demand: 92, price: 400, sales: [5, 10, 20, 40, 70, 92, 90, 60, 30, 15, 10, 8], materials: ["Windproof Frame", "Automatic Open", "Compact Size"] },
                { id: "M02", name: "Waterproof Footwear", season: "Monsoon", category: "Fashion", demand: 88, price: 800, sales: [10, 15, 25, 50, 75, 88, 85, 55, 30, 20, 15, 12], materials: ["Rubber Sole", "Quick Dry Mesh", "Anti-Skid"] },
                { id: "M03", name: "Dehumidifiers", season: "Monsoon", category: "Electronics", demand: 75, price: 12000, sales: [5, 8, 15, 30, 60, 75, 70, 40, 20, 10, 8, 6], materials: ["Portable Unit", "Smart Sensor", "Low Noise"] },
                { id: "M04", name: "Car Wiper Blades", season: "Monsoon", category: "Automotive", demand: 85, price: 600, sales: [10, 12, 20, 45, 70, 85, 80, 50, 25, 15, 12, 10], materials: ["Frameless Design", "Silicone Blade", "All-Weather"] },

                // Festival Products
                { id: "F01", name: "Ethnic Wear", season: "Festival", category: "Fashion", demand: 95, price: 2500, sales: [10, 15, 20, 25, 30, 40, 60, 80, 95, 85, 50, 20], materials: ["Silk Blend", "Hand-Embroidered", "Designer Kurta"] },
                { id: "F02", name: "Smartphones", season: "Festival", category: "Electronics", demand: 88, price: 18000, sales: [40, 45, 50, 55, 60, 65, 75, 85, 88, 80, 70, 60], materials: ["5G Enabled", "AMOLED Display", "Triple Camera"] },
                { id: "F03", name: "Jewellery", season: "Festival", category: "Beauty", demand: 85, price: 5000, sales: [15, 20, 25, 30, 40, 50, 65, 80, 85, 75, 45, 25], materials: ["Gold Plated", "Kundan Set", "Silver Oxidised"] },
                { id: "F04", name: "Sweets & Gift Packs", season: "Festival", category: "Food", demand: 98, price: 700, sales: [5, 10, 15, 20, 25, 35, 55, 75, 98, 90, 40, 15], materials: ["Dry Fruit Combo", "Assorted Chocolates", "Traditional Mithai"] },

                // Winter Products
                { id: "W01", name: "Jackets & Hoodies", season: "Winter", category: "Fashion", demand: 90, price: 1500, sales: [30, 20, 15, 10, 15, 25, 50, 70, 80, 85, 90, 60], materials: ["Fleece Lined", "Water Resistant Shell", "Puffer Style"] },
                { id: "W02", name: "Water Heaters (Geysers)", season: "Winter", category: "Electronics", demand: 85, price: 8000, sales: [10, 5, 8, 12, 20, 30, 50, 75, 80, 82, 85, 50], materials: ["Instant Heating", "5-Star Energy Rated", "Smart Control"] },
                { id: "W03", name: "Moisturizing Cream", season: "Winter", category: "Beauty", demand: 92, price: 300, sales: [20, 15, 10, 15, 25, 40, 60, 80, 85, 88, 92, 70], materials: ["Shea Butter", "Vitamin E Infused", "Non-Greasy"] },
                { id: "W04", name: "Coffee & Tea Makers", season: "Winter", category: "Food", demand: 78, price: 3000, sales: [30, 25, 20, 22, 30, 45, 60, 70, 75, 78, 80, 65], materials: ["Drip Coffee", "Espresso Machine", "Electric Kettle"] }
            ];
            
            // --- UI ELEMENT REFERENCES ---
            const productList = document.getElementById('product-list');
            const listTitle = document.getElementById('list-title');
            const categoryFiltersContainer = document.getElementById('category-filters');
            const searchBar = document.getElementById('search-bar');
            const loadingIndicator = document.getElementById('loading-indicator');
            const productListContainer = document.getElementById('product-list-container');

            // --- CORE APPLICATION LOGIC ---

            // Initialization
            const startApp = () => {
                updateStateFromURL();
                renderFilters();
                renderProducts();
                if (isFirebaseConfigured) {
                    setupFirebaseAuth();
                } else {
                    updateAuthUI(null);
                    showToast("Firebase not configured. Running in demo mode.", "warning");
                }
            };
            
            // --- RENDERING FUNCTIONS ---
            
            const renderProducts = () => {
                loadingIndicator.style.display = 'block';
                productList.style.display = 'none';

                setTimeout(() => {
                    productList.innerHTML = '';
                    
                    if (!currentSeason) {
                        listTitle.textContent = 'Select a season to begin...';
                        loadingIndicator.style.display = 'none';
                        productList.style.display = 'grid';
                        return;
                    }
                    
                    let filteredProducts = baseProducts.filter(p => p.season === currentSeason);

                    if (currentCategory !== 'All' && currentCategory !== 'My Watchlist') {
                        filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
                    } else if (currentCategory === 'My Watchlist') {
                         filteredProducts = baseProducts.filter(p => userWatchlist.has(p.id));
                    }

                    if (currentSearchTerm) {
                        filteredProducts = filteredProducts.filter(p => 
                            p.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                        );
                    }

                    // Dynamic Product Generation to meet count requirements
                    let finalProducts = [];
                    if (filteredProducts.length > 0 && currentCategory !== 'All' && currentCategory !== 'My Watchlist') {
                        while (finalProducts.length < 200) {
                            for (const product of filteredProducts) {
                                if (finalProducts.length >= 200) break;
                                const material = product.materials[finalProducts.length % product.materials.length];
                                const newPrice = Math.round(product.price * (1 + (Math.random() - 0.5) * 0.2));
                                const newDemand = Math.min(100, Math.round(product.demand * (1 + (Math.random() - 0.1) * 0.15)));
                                
                                finalProducts.push({
                                    ...product,
                                    id: `${product.id}-${finalProducts.length}`,
                                    name: `${product.name} (${material})`,
                                    price: newPrice,
                                    demand: newDemand
                                });
                            }
                        }
                    } else {
                        finalProducts = filteredProducts;
                    }
                    
                    // Apply regional adjustments
                    finalProducts = finalProducts.map(p => {
                        let demandMultiplier = 1.0;
                        if(currentRegion === 'North') {
                            if(p.season === 'Winter' || p.season === 'Festival') demandMultiplier = 1.15;
                            if(p.season === 'Summer' || p.season === 'Monsoon') demandMultiplier = 0.9;
                        } else if (currentRegion === 'South') {
                            if(p.season === 'Summer' || p.season === 'Monsoon') demandMultiplier = 1.15;
                            if(p.season === 'Winter') demandMultiplier = 0.85;
                        } else if (currentRegion === 'Coastal') {
                            if(p.season === 'Monsoon') demandMultiplier = 1.25;
                            if(p.season === 'Winter') demandMultiplier = 0.8;
                        }
                        return { ...p, demand: Math.min(100, Math.round(p.demand * demandMultiplier)) };
                    });

                    finalProducts.forEach(product => {
                        const card = document.createElement('div');
                        card.className = "bg-slate-800 rounded-lg shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer";
                        card.onclick = () => window.openProductDetail(product);

                        // Enhanced image mapping with comprehensive product coverage
                        const getProductImage = (product) => {
                            const imageMap = {
                                // Electronics - High Quality Product Images
                                'Air Conditioners': 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=400&h=300&fit=crop',
                                'Refrigerators': 'https://images.unsplash.com/photo-1584621674125-8d366885fcbe?w=400&h=300&fit=crop',
                                'Dehumidifiers': 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=400&h=300&fit=crop',
                                'Smartphones': 'https://images.unsplash.com/photo-1592286927505-1def25115558?w=400&h=300&fit=crop',
                                'Water Heaters': 'https://images.unsplash.com/photo-1581092162562-40038f70a8f0?w=400&h=300&fit=crop',
                                'Geysers': 'https://images.unsplash.com/photo-1584421898227-c4c71846e404?w=400&h=300&fit=crop',
                                'Copper Coil': 'https://images.unsplash.com/photo-1573537209143-0beb82b09ea1?w=400&h=300&fit=crop',
                                'Inverter Tech': 'https://images.unsplash.com/photo-1518611505868-4d76e93b8ed6?w=400&h=300&fit=crop',
                                'Smart WiFi': 'https://images.unsplash.com/photo-1589941013453-ec89f33b5e95?w=400&h=300&fit=crop',
                                'Double Door': 'https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=400&h=300&fit=crop',
                                'Smart Inverter': 'https://images.unsplash.com/photo-1562184552-997c6d667c69?w=400&h=300&fit=crop',
                                'Frost Free': 'https://images.unsplash.com/photo-1585770237236-9e6d66d84878?w=400&h=300&fit=crop',
                                '5G Enabled': 'https://images.unsplash.com/photo-1519869325930-281a07f1f86e?w=400&h=300&fit=crop',
                                'AMOLED Display': 'https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=400&h=300&fit=crop',
                                'Triple Camera': 'https://images.unsplash.com/photo-1610945415295-d2afb47614fe?w=400&h=300&fit=crop',
                                
                                // Fashion - Diverse Clothing Styles
                                'Pure Cotton': 'https://images.unsplash.com/photo-1551488831-00080933cdf0?w=400&h=300&fit=crop',
                                'Linen Blend': 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=400&h=300&fit=crop',
                                'Quick Dry': 'https://images.unsplash.com/photo-1506368299235-c3fa979af597?w=400&h=300&fit=crop',
                                'Cotton T-Shirts': 'https://images.unsplash.com/photo-1521572215197-c1ceba3d2471?w=400&h=300&fit=crop',
                                'Umbrellas': 'https://images.unsplash.com/photo-1611866288850-397cfba5fcff?w=400&h=300&fit=crop',
                                'Waterproof Footwear': 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&h=300&fit=crop',
                                'Ethnic Wear': 'https://images.unsplash.com/photo-1581974474159-8ea4ba97fa8f?w=400&h=300&fit=crop',
                                'Kurta': 'https://images.unsplash.com/photo-1609066194519-430cac16a0dd?w=400&h=300&fit=crop',
                                'Jackets': 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=400&h=300&fit=crop',
                                'Hoodies': 'https://images.unsplash.com/photo-1556821552-5fefe8c9ef14?w=400&h=300&fit=crop',
                                'Windproof Frame': 'https://images.unsplash.com/photo-1611866288850-397cfba5fcff?w=400&h=300&fit=crop',
                                'Automatic Open': 'https://images.unsplash.com/photo-1584308666744-24d5f400f628?w=400&h=300&fit=crop',
                                'Compact Size': 'https://images.unsplash.com/photo-1517411157260-becca63c9886?w=400&h=300&fit=crop',
                                'Rubber Sole': 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&h=300&fit=crop',
                                'Anti-Skid': 'https://images.unsplash.com/photo-1461231872834-11acaf07fff5?w=400&h=300&fit=crop',
                                'Hand-Embroidered': 'https://images.unsplash.com/photo-1581974474159-8ea4ba97fa8f?w=400&h=300&fit=crop',
                                'Designer Kurta': 'https://images.unsplash.com/photo-1609066194519-430cac16a0dd?w=400&h=300&fit=crop',
                                'Fleece Lined': 'https://images.unsplash.com/photo-1556821552-5fefe8c9ef14?w=400&h=300&fit=crop',
                                'Water Resistant Shell': 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=400&h=300&fit=crop',
                                'Puffer Style': 'https://images.unsplash.com/photo-1597042212624-bc64e66a4e3f?w=400&h=300&fit=crop',
                                
                                // Beauty & Personal Care
                                'Sunscreen Lotion': 'https://images.unsplash.com/photo-1608248543803-ba4f8c70ae0b?w=400&h=300&fit=crop',
                                'SPF 50': 'https://images.unsplash.com/photo-1596394516093-501ba68a0ba6?w=400&h=300&fit=crop',
                                'Gel Based': 'https://images.unsplash.com/photo-1634126033610-1d66d2b7196f?w=400&h=300&fit=crop',
                                'Water Resistant': 'https://images.unsplash.com/photo-1608248543803-ba4f8c70ae0b?w=400&h=300&fit=crop',
                                'Jewellery': 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=300&fit=crop',
                                'Gold Plated': 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=300&fit=crop',
                                'Kundan Set': 'https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?w=400&h=300&fit=crop',
                                'Silver Oxidised': 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=300&fit=crop',
                                'Moisturizing Cream': 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=400&h=300&fit=crop',
                                'Shea Butter': 'https://images.unsplash.com/photo-1608248543803-ba4f8c70ae0b?w=400&h=300&fit=crop',
                                'Vitamin E Infused': 'https://images.unsplash.com/photo-1634126033610-1d66d2b7196f?w=400&h=300&fit=crop',
                                'Non-Greasy': 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=400&h=300&fit=crop',
                                
                                // Automotive
                                'Car Wiper Blades': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop',
                                'Frameless Design': 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=300&fit=crop',
                                'Silicone Blade': 'https://images.unsplash.com/photo-1419750265846-f83c4c7c2d7d?w=400&h=300&fit=crop',
                                'All-Weather': 'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=400&h=300&fit=crop',
                                
                                // Food & Beverages
                                'Sweets': 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop',
                                'Gift Packs': 'https://images.unsplash.com/photo-1549007994-cb92caebd54b?w=400&h=300&fit=crop',
                                'Dry Fruit Combo': 'https://images.unsplash.com/photo-1585707916684-038ad11b98e8?w=400&h=300&fit=crop',
                                'Assorted Chocolates': 'https://images.unsplash.com/photo-1599599810694-b5ac4dd94549?w=400&h=300&fit=crop',
                                'Traditional Mithai': 'https://images.unsplash.com/photo-1606312519331-379a88e0df42?w=400&h=300&fit=crop',
                                'Coffee': 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=400&h=300&fit=crop',
                                'Tea Makers': 'https://images.unsplash.com/photo-1597318166773-dd6b5ac48e5f?w=400&h=300&fit=crop',
                                'Drip Coffee': 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&h=300&fit=crop',
                                'Espresso Machine': 'https://images.unsplash.com/photo-1610889556528-6ea7c4a3fe2d?w=400&h=300&fit=crop',
                                'Electric Kettle': 'https://images.unsplash.com/photo-1544787219-7f47ccb76574?w=400&h=300&fit=crop',
                                'Instant Heating': 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=400&h=300&fit=crop',
                                '5-Star Energy Rated': 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=400&h=300&fit=crop',
                                'Smart Control': 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=400&h=300&fit=crop'
                            };
                            
                            // Enhanced matching with priority order
                            for (const [key, url] of Object.entries(imageMap)) {
                                if (product.name.toLowerCase().includes(key.toLowerCase())) {
                                    return url;
                                }
                            }
                            
                            // Enhanced fallback with seasonal context
                            const seasonalImages = {
                                'Summer': {
                                    'Electronics': 'https://images.unsplash.com/photo-1631545806609-c2c0b5c2b9b8?w=400&h=300&fit=crop',
                                    'Fashion': 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=300&fit=crop',
                                    'Beauty': 'https://images.unsplash.com/photo-1556228720-195a672e8a03?w=400&h=300&fit=crop'
                                },
                                'Monsoon': {
                                    'Fashion': 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop',
                                    'Electronics': 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=300&fit=crop',
                                    'Automotive': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop'
                                },
                                'Festival': {
                                    'Fashion': 'https://images.unsplash.com/photo-1610030469983-98e550d6193c?w=400&h=300&fit=crop',
                                    'Electronics': 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=400&h=300&fit=crop',
                                    'Beauty': 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=300&fit=crop',
                                    'Food': 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=400&h=300&fit=crop'
                                },
                                'Winter': {
                                    'Fashion': 'https://images.unsplash.com/photo-1544022613-e87ca75a784a?w=400&h=300&fit=crop',
                                    'Electronics': 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=400&h=300&fit=crop',
                                    'Beauty': 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop',
                                    'Food': 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&h=300&fit=crop'
                                }
                            };
                            
                            return seasonalImages[product.season]?.[product.category] || 
                                   'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&h=300&fit=crop';
                        };

                        card.innerHTML = `
                            <img src="${getProductImage(product)}" alt="${product.name}" class="w-full h-40 object-cover">
                            <div class="p-4">
                                <h3 class="text-lg font-bold text-white">${product.name}</h3>
                                <p class="text-sm text-gray-400">${product.category} | ${product.season}</p>
                                <div class="mt-4 space-y-2 text-sm">
                                    <div class="flex justify-between"><span>Demand Score:</span> <span class="font-semibold text-amber-500">${product.demand.toFixed(1)}%</span></div>
                                    <div class="flex justify-between"><span>Forecast Price:</span> <span class="font-semibold text-white">‚Çπ${product.price.toLocaleString('en-IN')}</span></div>
                                    <div class="flex justify-between"><span>Units (Monthly):</span> <span class="font-semibold text-white">${(product.demand * 1000).toLocaleString('en-IN')}</span></div>
                                </div>
                            </div>
                        `;
                        productList.appendChild(card);
                    });
                    
                    updateListTitle(finalProducts.length);
                    loadingIndicator.style.display = 'none';
                    productList.style.display = 'grid';

                }, 500); // Simulate network/calculation delay
            };
            
            const renderFilters = () => {
                categoryFiltersContainer.innerHTML = '';
                if (!currentSeason) return;

                const categories = ['All', ...new Set(baseProducts.filter(p => p.season === currentSeason).map(p => p.category))];
                if (currentUser && userWatchlist.size > 0) {
                    categories.push('My Watchlist');
                }
                
                categories.forEach(cat => {
                    const button = document.createElement('button');
                    button.textContent = cat;
                    button.onclick = () => window.setCategory(cat);
                    button.className = `filter-btn category-btn text-gray-200 font-semibold py-2 px-4 rounded-lg transition-all duration-200 ${currentCategory === cat ? 'bg-amber-600' : 'bg-slate-700 hover:bg-amber-600'}`;
                    categoryFiltersContainer.appendChild(button);
                });
            };

            const updateListTitle = (count) => {
                let title = `Predicted Trends for ${currentSeason} Season`;
                if(currentRegion !== 'National') title += ` in ${currentRegion.replace(/([A-Z])/g, ' $1').trim()}`;
                if(currentCategory !== 'All') title += ` (Category: ${currentCategory})`;
                listTitle.textContent = title;
            };

            // --- EVENT HANDLERS & STATE UPDATERS ---

            window.setSeason = (season) => {
                currentSeason = season;
                currentCategory = 'All';
                document.querySelectorAll('.season-btn').forEach(btn => {
                    btn.classList.toggle('bg-amber-600', btn.textContent.includes(season));
                    btn.classList.toggle('bg-slate-700', !btn.textContent.includes(season));
                });
                updateURL();
                renderFilters();
                renderProducts();
            };

            window.setCategory = (category) => {
                currentCategory = category;
                updateURL();
                renderFilters();
                renderProducts();
            };

            window.setRegion = (region) => {
                currentRegion = region;
                updateURL();
                renderProducts();
            };
            
            searchBar.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    currentSearchTerm = e.target.value;
                    renderProducts();
                }, 300); // Debounce for 300ms
            });

            // --- URL STATE MANAGEMENT ---
            
            const updateURL = () => {
                const params = new URLSearchParams();
                if (currentSeason) params.set('season', currentSeason);
                if (currentCategory) params.set('category', currentCategory);
                if (currentRegion) params.set('region', currentRegion);
                
                // FIX: Wrap in try/catch to prevent SecurityError in blob/sandboxed environments
                try {
                    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
                } catch (e) {
                    console.error("URL state update failed in sandboxed environment. Functionality is preserved.", e);
                }
            };

            const updateStateFromURL = () => {
                const params = new URLSearchParams(window.location.search);
                const season = params.get('season');
                if (season) {
                    currentSeason = season;
                    currentCategory = params.get('category') || 'All';
                    currentRegion = params.get('region') || 'National';
                    document.getElementById('region-selector').value = currentRegion;
                    document.querySelectorAll('.season-btn').forEach(btn => {
                        btn.classList.toggle('bg-amber-600', btn.textContent.includes(season));
                        btn.classList.toggle('bg-slate-700', !btn.textContent.includes(season));
                    });
                }
            };

            // --- MODAL & UI HELPERS ---

            window.openModal = (modalId) => document.getElementById(modalId).classList.replace('hidden', 'flex');
            window.closeModal = (modalId) => document.getElementById(modalId).classList.replace('flex', 'hidden');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                };
                toast.className = `toast p-4 rounded-lg text-white shadow-lg ${colors[type]}`;
                toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            };

            // --- SPECIFIC MODAL CONTENT ---
            
            // Product Detail
            window.openProductDetail = (product) => {
                const content = document.getElementById('product-detail-content');
                const isWatched = userWatchlist.has(product.id);
                // Get appropriate image for product detail modal
                const getDetailImage = (product) => {
                    const imageMap = {
                        // Electronics
                        'Air Conditioners': 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=600&h=400&fit=crop',
                        'Refrigerators': 'https://images.unsplash.com/photo-1571175443880-49e1d25b2bc5?w=600&h=400&fit=crop',
                        'Dehumidifiers': 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600&h=400&fit=crop',
                        'Smartphones': 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=600&h=400&fit=crop',
                        'Water Heaters': 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=600&h=400&fit=crop',
                        'Geysers': 'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=600&h=400&fit=crop',
                        
                        // Fashion - Different T-Shirt Variations
                        'Pure Cotton': 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=600&h=400&fit=crop',
                        'Linen Blend': 'https://images.unsplash.com/photo-1434389677669-e08b4cac3105?w=600&h=400&fit=crop',
                        'Quick Dry': 'https://images.unsplash.com/photo-1583743814966-8936f37f4678?w=600&h=400&fit=crop',
                        'Cotton T-Shirts': 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=600&h=400&fit=crop',
                        'Umbrellas': 'https://images.unsplash.com/photo-1527266237111-a4989d028b4b?w=600&h=400&fit=crop',
                        'Waterproof Footwear': 'https://images.unsplash.com/photo-1549298916-b41d501d3772?w=600&h=400&fit=crop',
                        'Ethnic Wear': 'https://images.unsplash.com/photo-1594736797933-d0401ba2fe65?w=600&h=400&fit=crop',
                        'Kurta': 'https://images.unsplash.com/photo-1594736797933-d0401ba2fe65?w=600&h=400&fit=crop',
                        'Jackets': 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=600&h=400&fit=crop',
                        'Hoodies': 'https://images.unsplash.com/photo-1556821840-3a9c6dcb3be8?w=600&h=400&fit=crop',
                        
                        // Beauty
                        'Sunscreen Lotion': 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=600&h=400&fit=crop',
                        'Sunscreen': 'https://images.unsplash.com/photo-1556228578-8c89e6adf883?w=600&h=400&fit=crop',
                        'Jewellery': 'https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?w=600&h=400&fit=crop',
                        'Moisturizing Cream': 'https://images.unsplash.com/photo-1556228720-195a672e8a03?w=600&h=400&fit=crop',
                        
                        // Automotive
                        'Car Wiper Blades': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=600&h=400&fit=crop',
                        'Wiper': 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=600&h=400&fit=crop',
                        
                        // Food
                        'Sweets': 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=600&h=400&fit=crop',
                        'Gift Packs': 'https://images.unsplash.com/photo-1549007994-cb92caebd54b?w=600&h=400&fit=crop',
                        'Coffee': 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=600&h=400&fit=crop',
                        'Tea Makers': 'https://images.unsplash.com/photo-1544787219-7f47ccb76574?w=600&h=400&fit=crop'
                    };
                    
                    for (const [key, url] of Object.entries(imageMap)) {
                        if (product.name.toLowerCase().includes(key.toLowerCase())) {
                            return url;
                        }
                    }
                    
                    const categoryImages = {
                        'Electronics': 'https://images.unsplash.com/photo-1498049794561-7780e7231661?w=600&h=400&fit=crop',
                        'Fashion': 'https://images.unsplash.com/photo-1445205170230-053b83016050?w=600&h=400&fit=crop',
                        'Beauty': 'https://images.unsplash.com/photo-1596462502278-27bfdc403348?w=600&h=400&fit=crop',
                        'Automotive': 'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=600&h=400&fit=crop',
                        'Food': 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=600&h=400&fit=crop'
                    };
                    
                    return categoryImages[product.category] || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=600&h=400&fit=crop';
                };

                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img src="${getDetailImage(product)}" alt="${product.name}" class="w-full h-64 object-cover rounded-lg">
                            <h2 class="text-2xl font-bold text-white mt-4">${product.name}</h2>
                            <p class="text-gray-400">${product.category} | ${product.season} | ${currentRegion}</p>
                            <button id="watchlist-btn" class="w-full mt-4 py-2 px-4 rounded-lg font-semibold transition-colors ${isWatched ? 'bg-red-600 hover:bg-red-700' : 'bg-amber-600 hover:bg-amber-700'}">${isWatched ? 'Remove from Watchlist' : 'Add to Watchlist'}</button>
                        </div>
                        <div>
                            <div class="chart-container"><canvas id="sales-chart"></canvas></div>
                            <div class="mt-4 p-4 bg-slate-800/50 rounded-lg">
                                <h3 class="font-bold text-lg text-amber-500 mb-2">AI Marketing Tool</h3>
                                <p class="text-sm text-gray-300 mb-3">Generate a professional product description for your e-commerce store.</p>
                                <button id="generate-desc-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 px-4 rounded-lg font-semibold">Generate AI Description</button>
                                <div id="ai-description-container" class="mt-3 hidden">
                                    <textarea id="ai-description" class="w-full bg-slate-700 rounded-lg p-2 h-24 text-sm" readonly></textarea>
                                    <button id="copy-desc-btn" class="w-full mt-2 bg-slate-600 hover:bg-slate-500 py-1 px-3 text-xs rounded-lg">Copy to Clipboard</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                window.openModal('product-detail-modal');
                createSalesChart(product);

                document.getElementById('watchlist-btn').onclick = () => toggleWatchlist(product.id);
                document.getElementById('generate-desc-btn').onclick = () => generateProductDescription(product);
            };

            // Authentication
            window.openAuthModal = () => {
                if(currentUser) {
                    renderProfileView();
                } else {
                    renderLoginView();
                }
                window.openModal('auth-modal');
            };

            // Data Analysis
            document.getElementById('analyze-data-btn').onclick = () => {
                 document.getElementById('data-analysis-content').innerHTML = `
                    <h2 class="text-2xl font-bold text-amber-500 mb-4">Personalized Sales Analysis</h2>
                    <p class="text-gray-300 mb-6">Upload your shop's sales data (CSV/Excel) to get a custom report on your product performance, identifying your most profitable items and seasonal trends.</p>
                    <div class="text-center">
                         <input type="file" id="sales-file-input" class="hidden" accept=".csv, .xlsx">
                         <button onclick="document.getElementById('sales-file-input').click()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-6 rounded-lg">Upload Sales Data</button>
                    </div>
                    <div id="analysis-report" class="mt-6 hidden"></div>
                `;
                 window.openModal('data-analysis-modal');

                 document.getElementById('sales-file-input').onchange = (e) => {
                     if (e.target.files.length > 0) {
                         const reportContainer = document.getElementById('analysis-report');
                         reportContainer.innerHTML = `<div class="text-center text-amber-500">Analyzing ${e.target.files[0].name}...</div>`;
                         reportContainer.classList.remove('hidden');
                         
                         setTimeout(() => { // Simulate analysis
                             reportContainer.innerHTML = `
                                <h3 class="font-bold text-xl text-white mb-3">Analysis Complete: Key Insights</h3>
                                <div class="space-y-4 text-left">
                                    <div class="bg-slate-800 p-3 rounded-lg"><strong>Peak Season:</strong> Festival Season (Oct-Nov) drove 45% of your annual profit, led by Electronics.</div>
                                    <div class="bg-slate-800 p-3 rounded-lg"><strong>Top Performer:</strong> 'Premium Ethnic Wear' has the highest profit margin at 65%.</div>
                                    <div class="bg-slate-800 p-3 rounded-lg"><strong>Decline Trend:</strong> Fashion sales see a 30% drop post-Winter. Consider a clearance sale in February.</div>
                                    <div class="bg-green-800/50 p-3 rounded-lg text-green-300"><strong>Recommendation:</strong> Increase stock for smart home devices before the Festival season.</div>
                                </div>
                             `;
                         }, 1500);
                     }
                 };
            };


            // --- CHARTING & VISUALIZATION ---

            let salesChartInstance = null;
            const createSalesChart = (product) => {
                if(salesChartInstance) salesChartInstance.destroy();
                
                const ctx = document.getElementById('sales-chart').getContext('2d');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const priceData = product.sales.map(sale => {
                    const normalizedSale = sale / 100;
                    // Price is inversely related to off-season sales
                    const priceFactor = 1 - (normalizedSale * 0.7); // Price drops up to 70% in deep off-season
                    return Math.round(product.price * priceFactor);
                });

                salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Sales Volume Trend',
                                data: product.sales,
                                borderColor: '#10b981', // Emerald Green
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4,
                                fill: true,
                            },
                            {
                                label: 'Retail Price Fall',
                                data: priceData,
                                borderColor: '#ef4444', // Red
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.4,
                                fill: false,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { 
                                type: 'linear', position: 'left',
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#d1d5db' },
                                title: { display: true, text: 'Demand Score (%)', color: '#10b981'}
                            },
                            y1: {
                                type: 'linear', position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#d1d5db' },
                                title: { display: true, text: 'Forecast Price (‚Çπ)', color: '#ef4444'}
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#d1d5db' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#d1d5db' } }
                        }
                    }
                });
            };

            // --- FIREBASE AUTHENTICATION & DATA ---

            const setupFirebaseAuth = () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            ...userDoc.data()
                        };
                        fetchWatchlist();
                        if(currentUser.location) { // Auto-sync region
                             const regionMap = { 'delhi': 'North', 'mumbai': 'Coastal', 'chennai': 'South', 'kolkata': 'Coastal', 'bangalore': 'South' };
                             const locationKey = currentUser.location.toLowerCase();
                             if(regionMap[locationKey]) {
                                 document.getElementById('region-selector').value = regionMap[locationKey];
                                 setRegion(regionMap[locationKey]);
                             }
                        }
                    } else {
                        currentUser = null;
                        userWatchlist.clear();
                    }
                    updateAuthUI(currentUser);
                    renderFilters(); // Re-render to show/hide watchlist button
                });
            };

            const updateAuthUI = (user) => {
                const authBtn = document.getElementById('auth-btn');
                const analyzeBtn = document.getElementById('analyze-data-btn');
                if(user) {
                    authBtn.innerHTML = `
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg>
                         <span class="hidden md:inline">View Profile</span>
                    `;
                    analyzeBtn.classList.remove('hidden');
                } else {
                    authBtn.innerHTML = `
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                         <span class="hidden md:inline">Sign In</span>
                    `;
                    analyzeBtn.classList.add('hidden');
                }
            };

            const renderLoginView = () => {
                 document.getElementById('auth-content').innerHTML = `
                    <h2 class="text-2xl font-bold text-amber-500 mb-4 text-center">Sign In</h2>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" required class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                        <input type="password" id="login-password" placeholder="Password" required class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 rounded">Sign In</button>
                    </form>
                    <p class="text-center mt-4">New user? <button onclick="window.renderRegisterView()" class="text-amber-500 hover:underline">Create an account</button></p>
                 `;
                 document.getElementById('login-form').onsubmit = handleLogin;
            };

            window.renderRegisterView = () => {
                 document.getElementById('auth-content').innerHTML = `
                    <h2 class="text-2xl font-bold text-amber-500 mb-4 text-center">Create Account</h2>
                    <form id="register-form" class="space-y-4">
                        <input type="email" id="register-email" placeholder="Email" required class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                        <input type="password" id="register-password" placeholder="Password (min. 6 characters)" required class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 rounded">Register</button>
                    </form>
                    <p class="text-center mt-4">Already have an account? <button onclick="window.renderLoginView()" class="text-amber-500 hover:underline">Sign In</button></p>
                 `;
                 document.getElementById('register-form').onsubmit = handleRegister;
            };

            const renderProfileView = () => {
                 document.getElementById('auth-content').innerHTML = `
                    <h2 class="text-2xl font-bold text-amber-500 mb-4 text-center">My Profile</h2>
                    <form id="profile-form" class="space-y-4">
                         <p class="text-center text-gray-300">${currentUser.email}</p>
                         <input type="text" id="profile-shop-name" placeholder="Your Shop Name" value="${currentUser.shopName || ''}" class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                         <input type="text" id="profile-location" placeholder="Primary Market Location (e.g., Mumbai)" value="${currentUser.location || ''}" class="w-full p-2 bg-slate-700 rounded border border-slate-600">
                         <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">Save Profile</button>
                         <button type="button" onclick="window.signOutUser()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded">Sign Out</button>
                    </form>
                 `;
                 document.getElementById('profile-form').onsubmit = handleProfileUpdate;
            };

            // Firebase Handlers
            const handleRegister = async (e) => {
                e.preventDefault();
                if(!isFirebaseConfigured) { showToast("Demo Mode: Cannot create account.", "warning"); return; }
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { email: email });
                    closeModal('auth-modal');
                    showToast("Account created successfully!", "success");
                } catch (error) { showToast(error.message, "error"); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if(!isFirebaseConfigured) { showToast("Demo Mode: Cannot sign in.", "warning"); return; }
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal('auth-modal');
                    showToast("Signed in successfully!", "success");
                } catch (error) { showToast(error.message, "error"); }
            };

            const handleProfileUpdate = async (e) => {
                e.preventDefault();
                if(!isFirebaseConfigured || !currentUser) { showToast("You must be signed in.", "error"); return; }
                const shopName = document.getElementById('profile-shop-name').value;
                const location = document.getElementById('profile-location').value;
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { shopName, location });
                    currentUser = { ...currentUser, shopName, location };
                    showToast("Profile updated!", "success");
                    closeModal('auth-modal');
                } catch (error) { showToast(error.message, "error"); }
            };

            window.signOutUser = async () => {
                if(!isFirebaseConfigured) { showToast("Signed out from demo.", "success"); return; }
                try {
                    await signOut(auth);
                    closeModal('auth-modal');
                    showToast("Signed out.", "success");
                } catch (error) { showToast(error.message, "error"); }
            };

            // Watchlist Logic
            const fetchWatchlist = async () => {
                if (!currentUser || !isFirebaseConfigured) return;
                const querySnapshot = await getDocs(collection(db, `users/${currentUser.uid}/watchlist`));
                userWatchlist.clear();
                querySnapshot.forEach(doc => userWatchlist.add(doc.data().productId));
                renderFilters();
            };

            const toggleWatchlist = async (productId) => {
                 if (!currentUser || !isFirebaseConfigured) {
                    showToast("Please sign in to use the watchlist.", "warning");
                    return;
                }
                const docRef = doc(db, `users/${currentUser.uid}/watchlist`, productId);
                if (userWatchlist.has(productId)) {
                    await deleteDoc(docRef);
                    userWatchlist.delete(productId);
                    showToast("Removed from watchlist.", "success");
                } else {
                    await setDoc(docRef, { productId });
                    userWatchlist.add(productId);
                    showToast("Added to watchlist!", "success");
                }
                // Re-render button in modal
                const product = baseProducts.find(p => p.id === productId) || {id: productId};
                openProductDetail(product); 
                renderFilters();
            };

            // --- AI & CHATBOT LOGIC ---
            
            // Enhanced AI Description Generator with better prompts
            const generateProductDescription = async (product) => {
                const btn = document.getElementById('generate-desc-btn');
                const container = document.getElementById('ai-description-container');
                const textarea = document.getElementById('ai-description');
                const copyBtn = document.getElementById('copy-desc-btn');

                btn.textContent = 'Generating...';
                btn.disabled = true;

                // Enhanced AI-generated descriptions based on product details
                const descriptions = {
                    'Air Conditioners': `Experience ultimate comfort with our premium Air Conditioners featuring advanced inverter technology and smart WiFi controls. Energy-efficient cooling with whisper-quiet operation, perfect for ${currentRegion}'s climate. 5-star rated with copper coil durability. Transform your space into a cool sanctuary this ${product.season}.`,
                    
                    'Cotton T-Shirts': `Discover unmatched comfort with our premium Cotton T-Shirts collection. Crafted from ${product.materials?.[0] || 'pure cotton'}, these shirts offer breathable luxury perfect for ${product.season} weather. Available in vibrant colors with superior fit and finish. Your go-to choice for style and comfort at just ‚Çπ${product.price}.`,
                    
                    'Smartphones': `Unleash the power of technology with our latest 5G-enabled Smartphones featuring stunning AMOLED displays and advanced triple camera systems. Perfect for capturing ${product.season} memories with crystal-clear quality. Premium performance meets affordability at ‚Çπ${product.price}. Upgrade your digital lifestyle today.`,
                    
                    'Ethnic Wear': `Celebrate tradition with our exquisite Ethnic Wear collection featuring hand-embroidered designs and premium silk blends. Perfect for ${product.season} festivities, each piece tells a story of craftsmanship and elegance. Make every occasion memorable with authentic Indian fashion at ‚Çπ${product.price}.`,
                    
                    'Sunscreen Lotion': `Protect your skin with our advanced SPF 50+ Sunscreen Lotion, specially formulated for ${currentRegion}'s intense ${product.season} sun. Water-resistant gel-based formula provides long-lasting protection without greasiness. Dermatologist-tested for all skin types. Your daily defense against harmful UV rays.`,
                    
                    'Umbrellas': `Stay dry and stylish with our premium Umbrellas featuring windproof frames and automatic open technology. Compact yet durable, perfect for ${product.season} weather in ${currentRegion}. Superior water resistance with ergonomic grip. Your reliable companion for every rainy day at just ‚Çπ${product.price}.`,
                    
                    'Jewellery': `Adorn yourself with our stunning Jewellery collection featuring authentic Kundan sets and gold-plated designs. Each piece is crafted to perfection, ideal for ${product.season} celebrations and special occasions. Timeless elegance meets contemporary style. Make every moment sparkle at ‚Çπ${product.price}.`,
                    
                    'Sweets': `Indulge in our premium Sweets & Gift Packs featuring traditional mithai, dry fruit combos, and assorted chocolates. Perfect for ${product.season} celebrations and gifting. Made with finest ingredients and authentic recipes. Spread joy and sweetness with every bite at ‚Çπ${product.price}.`,
                    
                    'Jackets': `Embrace warmth and style with our premium Jackets collection featuring fleece-lined comfort and water-resistant shells. Perfect for ${currentRegion}'s ${product.season} weather with superior insulation and modern design. Available in trendy colors and sizes. Your winter essential at ‚Çπ${product.price}.`,
                    
                    'Water Heaters': `Experience instant hot water with our energy-efficient Water Heaters featuring smart controls and 5-star ratings. Advanced heating technology ensures consistent temperature perfect for ${product.season} comfort. Durable construction with safety features. Upgrade your bathing experience at ‚Çπ${product.price}.`
                };

                setTimeout(() => {
                    // Find matching description or generate generic one
                    let generatedText = descriptions['Default'] || `Discover premium quality with our ${product.name} featuring ${product.materials?.[0] || 'superior materials'} and exceptional craftsmanship. Perfectly designed for ${product.season} season in ${currentRegion}, offering unmatched value and performance. Experience excellence at just ‚Çπ${product.price}. Your trusted choice for quality and reliability.`;
                    
                    for (const [key, desc] of Object.entries(descriptions)) {
                        if (product.name.toLowerCase().includes(key.toLowerCase())) {
                            generatedText = desc;
                            break;
                        }
                    }
                    
                    textarea.value = generatedText;
                    container.classList.remove('hidden');
                    btn.textContent = 'Generate AI Description';
                    btn.disabled = false;
                }, 1500);

                copyBtn.onclick = () => {
                    textarea.select();
                    document.execCommand('copy');
                    showToast("Professional description copied to clipboard!", "success");
                };
            };
            
            // Chatbot
            window.toggleChat = () => {
                const widget = document.getElementById('chat-widget');
                widget.classList.toggle('hidden');
                if(!widget.classList.contains('hidden') && document.getElementById('chat-messages').children.length === 0) {
                    addBotMessage("üöÄ Welcome to HotDropz AI Assistant! I'm here to help you maximize your seasonal business opportunities. Ask me about trends, pricing, inventory, or any business strategy. How can I help you today?");
                }
            };
            
            // Enhanced AI Chatbot with comprehensive knowledge base
            const addMessage = (sender, message) => {
                const messagesContainer = document.getElementById('chat-messages');
                const msgDiv = document.createElement('div');
                msgDiv.className = `p-2 rounded-lg mb-2 max-w-[80%] ${sender === 'user' ? 'bg-amber-600 text-white self-end ml-auto' : 'bg-slate-700 text-gray-200 self-start'}`;
                msgDiv.textContent = message;
                messagesContainer.appendChild(msgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            const addBotMessage = (message) => addMessage('bot', message);

            // Advanced AI Response System
            const getAIResponse = (userMessage) => {
                const lowerMsg = userMessage.toLowerCase();
                
                // Seasonal Analysis
                if (lowerMsg.includes('summer') || lowerMsg.includes('hot')) {
                    return `For Summer season in ${currentRegion}, I recommend focusing on Air Conditioners (85% demand), Cotton T-Shirts (90% demand), and Sunscreen products (95% demand). Peak sales occur in April-June. Stock up 30% more in North India due to extreme heat.`;
                }
                
                if (lowerMsg.includes('monsoon') || lowerMsg.includes('rain')) {
                    return `Monsoon season shows high demand for Umbrellas (92% demand) and Waterproof Footwear (88% demand). Coastal regions see 25% higher sales. Best months: June-September. Consider bundling rain gear for better margins.`;
                }
                
                if (lowerMsg.includes('festival') || lowerMsg.includes('diwali')) {
                    return `Festival season is your goldmine! Ethnic Wear (95% demand), Smartphones (88% demand), and Sweets (98% demand) perform exceptionally. October-November sales can contribute 45% of annual profit. Increase inventory by 40%.`;
                }
                
                if (lowerMsg.includes('winter') || lowerMsg.includes('cold')) {
                    return `Winter demand peaks for Jackets & Hoodies (90% demand), Water Heaters (85% demand), and Moisturizing Cream (92% demand). North India shows 15% higher demand. December-February are key months.`;
                }
                
                // Product-specific insights
                if (lowerMsg.includes('ac') || lowerMsg.includes('air conditioner')) {
                    return `Air Conditioners show 85% demand score with ‚Çπ35,000 average price. Peak season: April-June. Inverter tech and Smart WiFi models perform 20% better. Consider offering installation services for competitive advantage.`;
                }
                
                if (lowerMsg.includes('smartphone') || lowerMsg.includes('phone')) {
                    return `Smartphones peak during Festival season (88% demand, ‚Çπ18,000 avg). 5G enabled models with AMOLED displays are trending. Festival discounts can boost sales by 35%. Target young demographics aged 18-35.`;
                }
                
                // Business strategy queries
                if (lowerMsg.includes('profit') || lowerMsg.includes('margin')) {
                    return `Highest profit margins: Beauty products (65%), Electronics during festivals (45%), Fashion accessories (40%). Seasonal timing increases margins by 20-30%. Bundle complementary products for higher average order value.`;
                }
                
                if (lowerMsg.includes('stock') || lowerMsg.includes('inventory')) {
                    return `Optimal stocking strategy: Maintain 2-3 months inventory for seasonal items. Pre-season stocking saves 15% costs. Use demand scores >80% as high-priority items. Regional preferences affect stock by ¬±25%.`;
                }
                
                if (lowerMsg.includes('risk') || lowerMsg.includes('loss')) {
                    return `Key risks: Overstocking off-season items (30% loss potential), weather variations affecting demand (¬±20%), competitor pricing (15% impact). Diversify across categories and maintain flexible supplier relationships.`;
                }
                
                // Regional insights
                if (lowerMsg.includes('north') || lowerMsg.includes('delhi')) {
                    return `North India preferences: Higher demand for Winter items (+15%), Festival products (+15%), AC units due to extreme summers. Price sensitivity is moderate. Focus on durability and brand value.`;
                }
                
                if (lowerMsg.includes('south') || lowerMsg.includes('chennai') || lowerMsg.includes('bangalore')) {
                    return `South India trends: Summer products (+15%), Monsoon gear (+15%), tech-savvy consumers prefer smart features. Higher purchasing power allows premium pricing. Cotton clothing highly preferred.`;
                }
                
                // Greetings and general
                if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('hey')) {
                    return `Hello! I'm your AI Forecast Assistant. I can help you with seasonal trends, product insights, pricing strategies, regional analysis, and business planning. What would you like to know about your market opportunities?`;
                }
                
                if (lowerMsg.includes('help') || lowerMsg.includes('what can you do')) {
                    return `I can assist with: üìä Seasonal demand analysis, üí∞ Pricing strategies, üìç Regional market insights, üìà Profit optimization, üéØ Product recommendations, üì¶ Inventory planning, üîÆ Market forecasting, and üèÜ Competitive analysis. Ask me anything!`;
                }
                
                // Default intelligent response
                return `I understand you're asking about "${userMessage}". Based on current ${currentSeason} season data in ${currentRegion}, I recommend focusing on high-demand products (>80% score). Would you like specific insights about seasonal trends, pricing strategies, or regional preferences?`;
            };

            document.getElementById('chat-form').onsubmit = async (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const userMessage = input.value.trim();
                if (!userMessage) return;
                
                addMessage('user', userMessage);
                input.value = '';

                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'p-2 rounded-lg mb-2 max-w-[80%] bg-slate-700 text-gray-400 self-start';
                typingDiv.textContent = 'AI is thinking...';
                typingDiv.id = 'typing-indicator';
                document.getElementById('chat-messages').appendChild(typingDiv);
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

                // Simulate AI processing time
                setTimeout(() => {
                    document.getElementById('typing-indicator')?.remove();
                    const response = getAIResponse(userMessage);
                    addBotMessage(response);
                }, 1000 + Math.random() * 1000); // 1-2 second delay for realism
            };

            // Start the application
            startApp();
        });
    </script>
</body>
</html>
